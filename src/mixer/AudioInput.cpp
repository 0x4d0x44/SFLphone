/* Generated by Together */

#include "AudioInput.h"
#include "TimeInfo.h"
#include <string.h>
#include "../tracePrintSFL.h"

AudioInput::AudioInput(){
  sem_init(&sem_fetchData,0,0);
  sem_init(&sem_putData,0,1);
  buffer= NULL;
  infoTemps= NULL;
  sizeBuffer= 0;
}

AudioInput::~AudioInput()
{
  if (buffer != NULL){
    delete buffer;
    buffer=NULL;
  }
  if (infoTemps!=NULL){
    delete infoTemps;
    infoTemps=NULL;
  }

}

void AudioInput::putData(short *data, int size, int timeStamp)
{
  if (data!=NULL && size>0)
  {
  	ptracesfl("AudioInput - putData(): Watting for data to be fetched",MT_INFO, AUDIOINPUT_TRACE);
  	sem_wait(&sem_putData);

  	if( this->buffer != NULL )
  		delete this->buffer;
    buffer = new short[size];
    
    if( this->infoTemps != NULL )
    	delete this->infoTemps;
    	
    infoTemps = new TimeInfo(timeStamp);
    memcpy(data,buffer,size);
    sizeBuffer=size;
    ptracesfl("AudioInput - putData(): Sending signal new data",MT_INFO, AUDIOINPUT_TRACE);
    sem_post(&sem_fetchData);
  }
  else
    ptracesfl("AudioInput - putData(): Parameter error",MT_ERROR, AUDIOINPUT_TRACE);
}

int AudioInput::fetchData(short *data) 
{ 
  if (buffer!=NULL && data!=NULL)
  {
    ptracesfl("AudioInput - fetchData(): Watting for data",MT_INFO, AUDIOINPUT_TRACE);
    sem_wait(&sem_fetchData);
    ptracesfl("AudioInput - fetchData(): Recieved new data",MT_INFO, AUDIOINPUT_TRACE);
    memcpy(buffer,data,sizeBuffer);
    sem_post(&sem_putData);
    ptracesfl("AudioInput - fetchData(): Data to be fetched",MT_INFO, AUDIOINPUT_TRACE);
    return this->sizeBuffer;
  }
  else
  {
    if( data == NULL )
  		ptracesfl("AudioInput - fetchData(): bad paramteter",MT_ERROR, AUDIOINPUT_TRACE);
  	else
    	ptracesfl("AudioInput - fetchData(): empty buffer",MT_ERROR, AUDIOINPUT_TRACE);
  }
  
  return -1;
}

int AudioInput::getSizeBuffer(){
	return this->sizeBuffer;
}

TimeInfo AudioInput::fetchTimeInfo(){
  return *this->infoTemps;
}

